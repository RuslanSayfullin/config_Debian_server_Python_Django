разработка Sayfullin RR
========================================================================================================================

// Руководство //
Как настроить Django с Postgres, Nginx и Gunicorn в Debian 11

Введение
Django — это мощная веб-инфраструктура, которая может помочь нам запустить ваше приложение Python или веб-сайт. 
Django включает в себя сервер разработки для локального тестирования вашего кода, но для всего, что хоть немного связано
с продакшином, требуется более безопасный и мощный веб-сервер.

В этом руководстве мы установим и настроим компоненты в Debian 11 для поддержки и обслуживания приложений Django. 
Мы будем настраивать базу данных PostgreSQL вместо использования базы данных SQLite по умолчанию.
Настроим сервер приложений Gunicorn для взаимодействия с нашими приложениями.
Затем настроим Nginx для обратного прокси-сервера к Gunicorn, что даст доступ к его функциям безопасности и 
производительности для обслуживания приложений.

========================================================================================================================

У нас должен быть новый экземпляр сервера Debian 11 с базовым брандмауэром и пользователем без полномочий root с sudo 
настроенными привилегиями.
Вы можете узнать, как это настроить, изучив наше руководство по первоначальной настройке сервера в файле:
SetUp_Debian11.md

Вы будете устанавливать Django в виртуальной среде. Установка Django в среду, специфичную для вашего проекта, позволит
обрабатывать ваши проекты и их требования отдельно.
После запуска базы данных и приложения, вы установите и настроите сервер приложений Gunicorn. 
Это будет служить интерфейсом для нашего приложения, переводя клиентские запросы из HTTP в вызовы Python, 
которые может обрабатывать наше приложение. Затем вы настроите Nginx перед Gunicorn, чтобы воспользоваться его 
высокопроизводительными механизмами обработки соединений и функциями безопасности.

Установка пакетов из репозиториев Debian:
Загрузите и установите все необходимые элементы из репозиториев Debian. Позже вы будете использовать диспетчер пакетов 
Python pip для установки дополнительных компонентов.
Сначала вам нужно обновить локальный apt индекс пакетов, а затем загрузить и установить пакеты.
    $ sudo apt update
    $ sudo apt install python3-venv python3-dev libpq-dev postgresql postgresql-contrib nginx curl
Эта команда установит инструмент для создания виртуальных сред для ваших проектов Python, файлы разработки Python, 
необходимые для последующей сборки Gunicorn, систему базы данных Postgres и библиотеки, необходимые для взаимодействия 
с ней, а также веб-сервер Nginx.

Создание базы данных PostgreSQL и пользователя:
Преступаем к созданию базы данных и пользователя базы данных для нашего приложения Django.
По умолчанию Postgres использует схему аутентификации, называемую «одноранговой аутентификацией» для локальных подключений.
Это означает, что если имя пользователя операционной системы совпадает с действительным именем пользователя Postgres, 
этот пользователь может войти в систему без дополнительной аутентификации.
Во время установки Postgres был создан пользователь операционной системы с именем postgres, соответствующим postgres 
пользователю-администратору PostgreSQL. Вам необходимо использовать этого пользователя для выполнения административных 
задач. Вы можете использовать sudo и передать имя пользователя с '-u' опцией.
Войдите в интерактивный сеанс Postgres, набрав:
    $ sudo -u postgres psql
Будет предоставлено приглашение PostgreSQL, в котором вы можно настроить наши требования.
Сначала создадим базу данных для проекта:
    postgres=# CREATE DATABASE myproject;
Далее создадим пользователя базы данных для нашего проекта. Обязательно выберите безопасный пароль:
    postgres=# CREATE USER myprojectuser WITH PASSWORD 'password';
После этого вы измените несколько параметров подключения для только что созданного пользователя. Это ускорит операции с 
базой данных, так что правильные значения не нужно запрашивать и устанавливать каждый раз при установлении соединения.
Вы установите кодировку символов по умолчанию на UTF-8, которую ожидает Django. Вы также устанавливаете схему изоляции 
транзакций по умолчанию на «чтение зафиксированных», которая блокирует чтение незафиксированных транзакций. 
Наконец, вы устанавливаете часовой пояс. По умолчанию проекты Django будут использовать файлы UTC. 
Это все рекомендации самого проекта Django :
    postgres=# ALTER ROLE myproject SET client_encoding TO 'utf8';
    postgres=# ALTER ROLE myproject SET default_transaction_isolation TO 'read committed';
    postgres=# ALTER ROLE myproject SET timezone TO 'UTC+5';
Теперь необходимо предоставить новому пользователю доступ для администрирования новой базы данных:
    postgres=# GRANT ALL PRIVILEGES ON DATABASE TO myprojectuser;
Выйдите из командной строки PostgreSQL, набрав:
    postgres=# \q
Теперь Postgres настроен так, что Django может подключаться к своей базе данных и управлять ею.

Создание виртуальной среды Python для вашего проекта
В каталоге проекта создайте виртуальную среду Python, набрав:
    $ python3 -m venv myprojectenv
Это создаст каталог с именем myprojectenv в myprojectdir каталоге. Внутри он установит локальную версию Python и
локальную версию pip для управления пакетами. Можно использовать эту структуру виртуальной среды для установки и 
настройки изолированной среды Python для любого проекта, который создаём.
Перед установкой требований Python для проекта необходимо активировать виртуальную среду. Сделать это:
    $ source myprojectenv/bin/activate
Ваше приглашение должно измениться, чтобы указать, что вы сейчас работаете в виртуальной среде Python. 

========================================================================================================================
Перейдите в директорию проекта с помощью команды: 
$ cd myproject
Установить зависимости из файла requirements.txt:
$ pip install -r requirements.txt

========================================================================================================================

Если вы следовали руководству по первоначальной настройке сервера, у вас должен быть брандмауэр UFW, защищающий сервер.
Чтобы протестировать сервер разработки, вам необходимо разрешить доступ к порту, который вы будете использовать.
Создайте исключение для порта 8000, набрав:
$ sudo ufw allow 8000

Наконец, вы можете протестировать свой проект, запустив сервер разработки Django с помощью этой команды:
python3 manage.py runserver 0.0.0.0:8000

Приложение будет доступно по адресу: 
http://server_domain_or_IP:8000

Если вы добавите /admin в конец URL-адреса в адресной строке, вам будет предложено ввести имя пользователя и пароль 
администратора, которые вы создали с помощью createsuperuser команды.
После аутентификации вы можете получить доступ к административному интерфейсу Django по умолчанию.

Когда вы закончите изучение, нажмите CTRL-C в окне терминала, чтобы выключить сервер разработки.

Проверка способности Gunicorn служить проекту
========================================================================================================================

Нужно, прежде чем покинуть виртуальную среду, — протестировать Gunicorn убедиться, что он может обслуживать приложение.
Войдите в каталог проекта и используя gunicorn для загрузки модуля WSGI проекта:
    $ cd ~/myprojectdir
    $ gunicorn --bind 0.0.0.0:8000 myproject.wsgi

Это запустит Gunicorn на том же интерфейсе, на котором работал сервер разработки Django. 
Можно вернуться и снова протестировать приложение в своем браузере.
* Примечание. К интерфейсу администратора не будут применены стили, поскольку Gunicorn не знает,
как найти статический контент CSS, ответственный за это.

Мы передали Gunicorn модуль, указав относительный путь к wsgi.py файлу Django, который является точкой входа в ваше 
приложение, используя синтаксис модуля Python. Внутри этого файла определена вызываемая функция application, которая 
используется для связи с приложением. 

Нажмите CTRL-C в окне терминала, чтобы остановить Gunicorn.
Закончили настройку приложения Django. Вы можете выйти из нашей виртуальной среды, набрав:
$ deactivate

Индикатор виртуальной среды в вашем приглашении будет удален.


Создание системных сокетов и служебных файлов для Gunicorn
========================================================================================================================

Мы проверили, что Gunicorn может взаимодействовать с нашим приложением Django, теперь следует реализовать более надежный
способ запуска и остановки сервера приложений. Для этого вы создадите службу systemd и файлы сокетов.

Сокет Gunicorn будет создан при загрузке и будет прослушивать соединения. Когда происходит соединение, 
systemd автоматически запускает процесс Gunicorn для обработки соединения.

Начните с создания и открытия файла сокета systemd для Gunicorn с sudo привилегиями:
    $ sudo nano /etc/systemd/system/gunicorn.socket

Внутри создадим [Unit]раздел для описания сокета, [Socket] раздел для определения местоположения сокета и 
[Install]раздел, чтобы убедиться, что сокет создан в нужное время:

/etc/systemd/system/gunicorn.socket 
------------------------------------
    [Unit]
    Description=gunicorn socket
    
    [Socket]
    ListenStream=/run/gunicorn.sock
    
    [Install]
    WantedBy=sockets.target
------------------------------------

Сохраните и закройте файл, когда закончите.
Затем создайте и откройте служебный файл systemd для Gunicorn с sudo привилегиями в текстовом редакторе. 
Имя файла службы должно совпадать с именем файла сокета, за исключением расширения:
    $ sudo nano /etc/systemd/system/gunicorn.service

Начните с [Unit] раздела, который используется для указания метаданных и зависимостей. Поместите здесь описание службы и
скажите системе инициализации, чтобы она запускалась только после достижения сетевой цели. Поскольку ваша служба 
использует сокет из файла сокета, вам необходимо включить Requires директиву, указывающую на эту связь:

/etc/systemd/system/gunicorn.service 
-------------------------------------
[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target
-------------------------------------

Далее напишете [Service] раздел. Укажите пользователя и группу, под которой вы хотите запустить процесс. 
Предоставите своей обычной учетной записи пользователя право собственности на процесс, поскольку она владеет всеми 
соответствующими файлами. Вы передадите группе право собственности на www-data группу, чтобы Nginx мог взаимодействовать
с Gunicorn.

Затем наметьте рабочий каталог и укажете команду для запуска службы. Указать полный путь к исполняемому файлу Gunicorn, 
который установлен в нашей виртуальной среде. Затем вы привяжете процесс к сокету Unix, который вы создали в /run
каталоге, чтобы процесс мог взаимодействовать с Nginx. Запишите все данные в стандартный вывод, чтобы journald процесс
мог собирать журналы Gunicorn. Вы также можете указать здесь любые дополнительные настройки Gunicorn.
Например, в данном случае вы указали 3 рабочих процесса:

/etc/systemd/system/gunicorn.service 
-------------------------------------
[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
User=sammy
Group=www-data
WorkingDirectory=/home/sammy/myprojectdir
ExecStart=/home/sammy/myprojectdir/myprojectenv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          --bind unix:/run/gunicorn.sock \
          myproject.wsgi:application
-------------------------------------

Наконец, вы добавите [Install] раздел. Это сообщит systemd, с чем связать эту службу, если вы включите ее запуск при 
загрузке. Вы хотите, чтобы эта служба запускалась, когда обычная многопользовательская система запущена и работает:

/etc/systemd/system/gunicorn.service 
-------------------------------------
[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
User=sammy
Group=www-data
WorkingDirectory=/home/sammy/myprojectdir
ExecStart=/home/sammy/myprojectdir/myprojectenv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          --bind unix:/run/gunicorn.sock \
          myproject.wsgi:application

[Install]
WantedBy=multi-user.target
-------------------------------------

На этом ваш служебный файл systemd готов. Сохраните и закройте его сейчас.

Теперь вы можете запустить и включить сокет Gunicorn. Это создаст файл сокета /run/gunicorn.sock сейчас и при загрузке. 
Когда к этому сокету будет установлено соединение, systemd автоматически запустит его gunicorn.service для обработки:

# команды nginx
    $ sudo service nginx start
    $ sudo service nginx stop
    $ sudo service nginx restart
    $ sudo service nginx status
    $ sudo nginx -t
    $ sudo systemctl start gunicorn.socket
    $ sudo systemctl enable gunicorn.socket

Вы можете подтвердить, что операция прошла успешно, проверив файл сокета.


Проверка файла сокета Gunicorn
========================================================================================================================

Проверьте статус процесса, чтобы узнать, удалось ли ему запуститься:
    $ sudo systemctl status gunicorn.socket

Затем проверьте наличие gunicorn.sockфайла в /runкаталоге:
    $ file /run/gunicorn.sock

Если systemctl status команда указала, что произошла ошибка, или если вы не нашли gunicorn.sock файл в каталоге, 
это указывает на то, что сокет Gunicorn не удалось правильно создать. Проверьте журналы сокета Gunicorn, набрав:
    $ sudo journalctl -u gunicorn.socket
Прежде чем продолжить, еще раз просмотрите свой /etc/systemd/system/gunicorn.socketфайл, чтобы исправить все проблемы.


Тестирование активации сокета
========================================================================================================================

В настоящее время, если вы только запустили gunicorn.socket модуль, gunicorn.service он еще не будет активен, так как 
сокет еще не получил никаких подключений. Вы можете проверить это, набрав:
    $ sudo systemctl status gunicorn

Чтобы проверить механизм активации сокета, вы можете отправить соединение с сокетом curl, набрав:
    $ curl --unix-socket /run/gunicorn.sock localhost

Вы должны получить вывод HTML из вашего приложения в терминале. Это указывает на то, что Gunicorn запущен и может 
обслуживать ваше приложение Django. Вы можете убедиться, что служба Gunicorn запущена, набрав:
    $ sudo systemctl status gunicorn

Если выходные данные curl или выходные systemctl status данные указывают на то, что возникла проблема, проверьте 
дополнительные сведения в журналах:
    $ sudo journalctl -u gunicorn

Проверьте свой /etc/systemd/system/gunicorn.service файл на наличие проблем. Если вы вносите изменения в 
/etc/systemd/system/gunicorn.service файл, перезагрузите демон, чтобы перечитать определение службы, и перезапустите 
процесс Gunicorn, набрав:
    $ sudo systemctl daemon-reload
    $ sudo systemctl restart gunicorn
Прежде чем продолжить, убедитесь, что вы устранили указанные выше проблемы.


Настройте Nginx для передачи прокси-сервера Gunicorn
========================================================================================================================
Теперь, когда Gunicorn настроен, вам нужно настроить Nginx для передачи трафика процессу.
Начните с создания и открытия нового блока сервера в sites-available каталоге Nginx:
    $ sudo nano /etc/nginx/sites-available/backend

Внутри откройте новый серверный блок. Вы начнете с указания, что этот блок должен прослушивать обычный порт 80 и что он 
должен отвечать на доменное имя или IP-адрес вашего сервера:

/etc/nginx/доступные сайты/мой проект 
-------------------------------------
server {
    listen 80;
    server_name server_domain_or_IP;
}
-------------------------------------

Далее укажете Nginx игнорировать любые проблемы с поиском фавикона. Укажите, где найти статические ресурсы, которые
собрали в своем каталоге. Все эти файлы имеют стандартный префикс URI «/static», поэтому можете создать блок 
местоположения для соответствия этим запросам:~/myprojectdir/static

/etc/nginx/доступные сайты/мой проект 
-------------------------------------
server {
    listen 80;
    server_name server_domain_or_IP;

    location = /favicon.ico { access_log off; log_not_found off; }
    location /static/ {
        root /home/sammy/myprojectdir;
    }
}
--------------------------------------

Наконец, создайте location / {}блок, соответствующий всем другим запросам. Внутри этого места вы включите стандартный 
proxy_params файл, включенный в установку Nginx, а затем передадите трафик непосредственно в сокет Gunicorn:

/etc/nginx/доступные сайты/мой проект
-------------------------------------
server {
    listen 80;
    server_name server_domain_or_IP;

    location = /favicon.ico { access_log off; log_not_found off; }
    location /static/ {
        root /home/sammy/myprojectdir;
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn.sock;
    }
}
-------------------------------------

Сохраните и закройте файл, когда закончите. Теперь вы можете включить файл, связав его с sites-enabled каталогом:
    $ sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled

Проверьте конфигурацию Nginx на наличие синтаксических ошибок, набрав:
    $ sudo nginx -t

Нужно открыть брандмауэр для обычного трафика через порт 80. Поскольку вам больше не нужен доступ к серверу разработки, 
вы также можете удалить правило для открытия порта 8000:
    $ sudo ufw delete allow 8000
    $ sudo ufw allow 'Nginx Full'


Устранение неполадок Nginx и Gunicorn
========================================================================================================================

Если на этом последнем шаге ваше приложение не отображается, вам необходимо устранить неполадки при установке.

Nginx показывает страницу по умолчанию вместо приложения Django
Если Nginx отображает страницу по умолчанию вместо прокси для вашего приложения, это обычно означает, что вам нужно 
настроить server_name внутри файла, чтобы он указывал на IP-адрес или доменное имя вашего сервера
/etc/nginx/sites-available/myproject

Nginx использует, server_name чтобы определить, какой серверный блок использовать для ответа на запросы. 
Если вы получаете страницу Nginx по умолчанию, это означает, что Nginx не смог явно сопоставить запрос с блоком сервера,
поэтому он возвращается к блоку по умолчанию, определенному в /etc/nginx/sites-available/default.
Блок server_name сервера вашего проекта должен быть более конкретным, чем блок сервера по умолчанию, который будет выбран.


Nginx отображает ошибку 502 Bad Gateway вместо приложения Django
========================================================================================================================


Ошибка 502 указывает на то, что Nginx не может успешно проксировать запрос. Широкий спектр проблем с конфигурацией 
выражается в ошибке 502, поэтому для правильного устранения неполадок требуется дополнительная информация.

Основное место для поиска дополнительной информации — журналы ошибок Nginx. Как правило, это скажет вам, какие условия 
вызвали проблемы во время проксирования. Следите за журналами ошибок Nginx, набрав:
    $ sudo tail -F /var/log/nginx/error.log






Исходники:
========================================================================================================================
https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-debian-11